name: Build macOS DMG

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g. 1.0.5)'
        required: true
        default: '1.0.5'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller dmgbuild pillow

      - name: Convert logo to ICNS
        run: |
          python -c "
          from PIL import Image
          import os
          import subprocess

          png_path = 'assets/logo.png'
          iconset_dir = 'assets/logo.iconset'
          icns_path = 'assets/logo.icns'

          # Create iconset directory
          os.makedirs(iconset_dir, exist_ok=True)

          # Generate required icon sizes for macOS
          img = Image.open(png_path)
          if img.mode != 'RGBA':
              img = img.convert('RGBA')

          sizes = [16, 32, 64, 128, 256, 512, 1024]
          for size in sizes:
              icon = img.resize((size, size), Image.Resampling.LANCZOS)
              icon.save(os.path.join(iconset_dir, f'icon_{size}x{size}.png'))
              if size <= 512:  # @2x versions
                  icon_2x = img.resize((size * 2, size * 2), Image.Resampling.LANCZOS)
                  icon_2x.save(os.path.join(iconset_dir, f'icon_{size}x{size}@2x.png'))

          # Convert iconset to icns
          subprocess.run(['iconutil', '-c', 'icns', iconset_dir, '-o', icns_path], check=True)
          print(f'Created {icns_path}')
          "

      - name: Update version in code
        run: |
          BUILD_DATE=$(date +%Y-%m-%d)
          sed -i '' "s/BUILD_DATE = .*/BUILD_DATE = \"$BUILD_DATE\"/" src/updater/version.py
          sed -i '' "s/CURRENT_VERSION = .*/CURRENT_VERSION = \"${{ steps.version.outputs.version }}\"/" src/updater/version.py

      - name: Build with PyInstaller
        run: |
          pyinstaller HelixOne.spec --clean --noconfirm

      - name: Verify app bundle
        run: |
          if [ -d "dist/HelixOne.app" ]; then
            APP_SIZE=$(du -sh dist/HelixOne.app | awk '{print $1}')
            echo "HelixOne.app created successfully ($APP_SIZE)"

            # Check code signing (won't be signed in CI, but check structure)
            codesign -dv dist/HelixOne.app 2>&1 || echo "App not signed (expected in CI)"
          else
            echo "Error: HelixOne.app not found"
            exit 1
          fi

      - name: Create DMG
        run: |
          # Simple DMG creation using hdiutil
          mkdir -p dist/dmg
          cp -r dist/HelixOne.app dist/dmg/

          # Create a symbolic link to Applications
          ln -s /Applications dist/dmg/Applications

          # Create DMG
          hdiutil create -volname "HelixOne" \
            -srcfolder dist/dmg \
            -ov -format UDZO \
            dist/HelixOne.dmg

          DMG_SIZE=$(du -sh dist/HelixOne.dmg | awk '{print $1}')
          echo "DMG created: HelixOne.dmg ($DMG_SIZE)"

      - name: Verify DMG
        run: |
          if [ -f "dist/HelixOne.dmg" ]; then
            SIZE=$(du -sh dist/HelixOne.dmg | awk '{print $1}')
            echo "DMG verified: $SIZE"

            # Mount and check contents
            hdiutil attach dist/HelixOne.dmg -readonly -nobrowse -mountpoint /tmp/helixone_dmg
            ls -la /tmp/helixone_dmg/
            hdiutil detach /tmp/helixone_dmg
          else
            echo "Error: DMG not found"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelixOne-macOS-DMG
          path: dist/HelixOne.dmg

      - name: Upload to GitHub Release (automatic)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/HelixOne.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to existing release (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          gh release upload "v${{ steps.version.outputs.version }}" "dist/HelixOne.dmg" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
